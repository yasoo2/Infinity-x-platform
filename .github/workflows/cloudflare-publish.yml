name: Publish Cloudflare Worker

on:
  workflow_dispatch:
  push:
    paths:
      - 'infra/cloudflare/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Wrangler
        run: npm i -g wrangler
      - name: Prepare temp wrangler config
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          sed -e "s|<YOUR_CLOUDFLARE_ACCOUNT_ID>|${CF_ACCOUNT_ID}|g" \
              -e "s|<YOUR_ZONE_ID>|${CF_ZONE_ID}|g" \
              infra/cloudflare/wrangler.toml > infra/cloudflare/wrangler.temp.toml
      - name: Publish Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: wrangler publish --config infra/cloudflare/wrangler.temp.toml
