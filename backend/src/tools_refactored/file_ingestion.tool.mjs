/**\n * ðŸ“¥ File Ingestion Tool - The AI\'s Eyes on User Files\n * @version 1.0.0\n * This tool allows the system to receive and process files from users, making the AI aware of their contents.\n * It saves the file and records the event in memory, enabling context-aware conversations about the file.\n */\n\nimport { promises as fs } from \'fs\';\nimport path from \'path\';\nimport os from \'os\';\nimport { v4 as uuidv4 } from \'uuid\';\n\n// We need a stable place to store these uploads, at least temporarily.\nconst UPLOAD_DIR = path.join(os.tmpdir(), \'infinity-uploads\');\n\n// We can import the memoryManager directly if it\'s a singleton, but it\'s better to pass it in.\n// For now, we will assume it is available as a dependency injected elsewhere, and this tool is a proxy.\n// This file is about defining the tool, the execution is handled by the ToolManager which has context.\nimport MemoryManager from \'../../services/memory/memory.service.mjs\';\nconst memoryManager = new MemoryManager(); // Lightweight instantiation for access to methods.\n\nasync function initializeService() {\n    try {\n        await fs.mkdir(UPLOAD_DIR, { recursive: true });\n    } catch (error) {\n        console.error(\'Failed to initialize upload directory:\', error);\n    }\n}\ninitializeService();\n\n// --- Tool Function ---\n\nasync function ingestFile({ fileName, fileContent, userId, sessionId }) {\n    const fileId = uuidv4();\n    const fileExtension = path.extname(fileName);\n    const storedFileName = `${fileId}${fileExtension}`;
    const filePath = path.join(UPLOAD_DIR, storedFileName);\n\n    try {\n        // 1. Save the file to a known location\n        await fs.writeFile(filePath, Buffer.from(fileContent, \'base64\'));\n\n        // 2. Create a summary of the event for the AI\'s memory\n        const summary = `A file named \\\"${fileName}\\\" has been uploaded by the user. It is stored with reference ID ${storedFileName}. Its contents are now available for analysis, review, or processing.`;\n\n        // 3. Save this event as a special interaction in the AI\'s memory\n        await memoryManager.saveInteraction(userId, `[System Event: File Upload - ${fileName}]`, summary, {\n            sessionId,\n            service: \'file-ingestion-tool\',\n            isSystemEvent: true,\n            fileMetadata: {\n                originalName: fileName,\n                storedName: storedFileName,\n                filePath: filePath,\n                size: Buffer.from(fileContent, \'base64\').length\n            }\n        });\n\n        return {\n            success: true,\n            message: `File \\\"${fileName}\\\" has been ingested and is now part of the conversation context.`,\n            fileName: fileName,\n            fileId: storedFileName\n        };\n\n    } catch (error) {\n        console.error(`[FileIngestionTool] Error ingesting file ${fileName}:`, error);\n        return { success: false, error: `Failed to ingest file: ${error.message}` };\n    }\n}\n\n// --- Metadata for Dynamic Discovery ---\n\ningestFile.metadata = {\n    name: \"ingestFile\",\n    description: \"Processes a user-uploaded file by saving it and making its content available to the AI for further actions like code review, analysis, or summarization. The file content should be base64 encoded.\",\n    parameters: {\n        type: \"object\",\n        properties: {\n            fileName: {\n                type: \"string\",\n                description: \"The original name of the file (e.g., \'main.py\', \'package.json\').\"\n            },\n            fileContent: {\n                type: \"string\",\n                description: \"The base64 encoded content of the file.\"\n            },\n            userId: {\n                type: \"string\",\n                description: \"The ID of the user uploading the file.\"\n            },\n            sessionId: {\n                type: \"string\",\n                description: \"The current session ID to associate the file with the ongoing conversation.\"\n            }\n        },\n        required: [\"fileName\", \"fileContent\", \"userId\", \"sessionId\"]\n    }\n};\n\n// --- Exporting the tool in the expected format ---\n\nexport default { ingestFile };\n